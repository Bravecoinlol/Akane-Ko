<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Bot 管理儀表板</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        .card-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .btn-custom {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        .config-form {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        .preview-container {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-unknown { background-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-white text-center mb-4">
                    <i class="fas fa-robot"></i> Discord Bot 管理儀表板
                </h1>
            </div>
        </div>

        <!-- 系統狀態 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="cpu-percent">--</div>
                    <div class="metric-label">CPU 使用率</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="memory-percent">--</div>
                    <div class="metric-label">記憶體使用率</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="disk-percent">--</div>
                    <div class="metric-label">磁碟使用率</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="network-sent">--</div>
                    <div class="metric-label">網路傳送 (MB)</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 系統監控 -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> 系統監控</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">記憶體使用量</small>
                                <div id="memory-details">-- GB / -- GB</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">磁碟使用量</small>
                                <div id="disk-details">-- GB / -- GB</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-6">
                                <small class="text-muted">網路接收</small>
                                <div id="network-recv">-- MB</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">最後更新</small>
                                <div id="last-update">--</div>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-custom mt-3" onclick="refreshSystemInfo()">
                            <i class="fas fa-sync-alt"></i> 重新整理
                        </button>
                    </div>
                </div>
            </div>

            <!-- 機器人控制 -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cogs"></i> 機器人控制</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <span class="status-indicator status-unknown" id="bot-status"></span>
                            <span id="bot-status-text">檢查中...</span>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-custom" onclick="controlBot('start')">
                                <i class="fas fa-play"></i> 啟動機器人
                            </button>
                            <button class="btn btn-warning btn-custom" onclick="controlBot('restart')">
                                <i class="fas fa-redo"></i> 重啟機器人
                            </button>
                            <button class="btn btn-danger btn-custom" onclick="controlBot('stop')">
                                <i class="fas fa-stop"></i> 停止機器人
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 日誌查看 -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-file-alt"></i> 系統日誌</h5>
                    </div>
                    <div class="card-body">
                        <div class="log-container" id="log-container">
                            <div class="text-muted">載入中...</div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary btn-custom" onclick="refreshLogs()">
                                <i class="fas fa-sync-alt"></i> 重新整理日誌
                            </button>
                            <button class="btn btn-secondary btn-custom" onclick="clearLogs()">
                                <i class="fas fa-trash"></i> 清除顯示
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 歡迎卡片配置 -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-image"></i> 歡迎卡片配置</h5>
                    </div>
                    <div class="card-body">
                        <form id="welcome-card-form" class="config-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">背景圖片</label>
                                        <select class="form-select" id="background-image">
                                            <option value="">載入中...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">字體文件</label>
                                        <select class="form-select" id="font-file">
                                            <option value="">載入中...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">字體大小</label>
                                        <input type="number" class="form-control" id="font-size" min="10" max="200">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">文字顏色</label>
                                        <input type="color" class="form-control" id="text-color">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">主文字位置 X</label>
                                        <input type="number" class="form-control" id="main-text-x">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">主文字位置 Y</label>
                                        <input type="number" class="form-control" id="main-text-y">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">副標題位置 X</label>
                                        <input type="number" class="form-control" id="subtitle-x">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">副標題位置 Y</label>
                                        <input type="number" class="form-control" id="subtitle-y">
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary btn-custom" onclick="saveConfig()">
                                    <i class="fas fa-save"></i> 保存配置
                                </button>
                                <button type="button" class="btn btn-info btn-custom" onclick="generatePreview()">
                                    <i class="fas fa-eye"></i> 生成預覽
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 預覽區域 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-eye"></i> 歡迎卡片預覽</h5>
                    </div>
                    <div class="card-body">
                        <div class="preview-container" id="preview-container">
                            <div class="text-muted">點擊「生成預覽」按鈕來查看效果</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局變數
        let systemInfoInterval;
        let logsInterval;

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadWelcomeCardConfig();
            loadAvailableFiles();
            refreshSystemInfo();
            refreshLogs();
            checkBotStatus();
            
            // 設置定時更新
            systemInfoInterval = setInterval(refreshSystemInfo, 5000);
            logsInterval = setInterval(refreshLogs, 10000);
            setInterval(checkBotStatus, 10000); // 每10秒檢查Bot狀態
        });

        // 系統信息
        async function refreshSystemInfo() {
            try {
                const response = await fetch('/api/system');
                const data = await response.json();
                
                document.getElementById('cpu-percent').textContent = data.cpu_percent + '%';
                document.getElementById('memory-percent').textContent = data.memory.percent + '%';
                document.getElementById('disk-percent').textContent = data.disk.percent + '%';
                document.getElementById('network-sent').textContent = Math.round(data.net.bytes_sent / 1024 / 1024) + ' MB';
                
                document.getElementById('memory-details').textContent = 
                    `${Math.round(data.memory.used / 1024 / 1024 / 1024)} GB / ${Math.round(data.memory.total / 1024 / 1024 / 1024)} GB`;
                document.getElementById('disk-details').textContent = 
                    `${Math.round(data.disk.used / 1024 / 1024 / 1024)} GB / ${Math.round(data.disk.total / 1024 / 1024 / 1024)} GB`;
                document.getElementById('network-recv').textContent = Math.round(data.net.bytes_recv / 1024 / 1024) + ' MB';
                document.getElementById('last-update').textContent = data.time;
                
            } catch (error) {
                console.error('獲取系統信息失敗:', error);
            }
        }

        // 日誌功能
        async function refreshLogs() {
            try {
                const response = await fetch('/api/log?lines=50');
                const data = await response.json();
                
                const logContainer = document.getElementById('log-container');
                if (data.log && data.log.length > 0) {
                    logContainer.innerHTML = data.log.split('\n').map(log => 
                        `<div class="log-line">${log}</div>`
                    ).join('');
                    logContainer.scrollTop = logContainer.scrollHeight;
                } else {
                    logContainer.innerHTML = '<div class="text-muted">無日誌記錄</div>';
                }
            } catch (error) {
                console.error('獲取日誌失敗:', error);
            }
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '<div class="text-muted">日誌已清除</div>';
        }

        // 機器人控制
        async function controlBot(action) {
            try {
                let url = '';
                if (action === 'restart') {
                    url = '/api/bot/restart';
                } else if (action === 'stop') {
                    url = '/api/bot/stop';
                } else {
                    alert('無效的操作');
                    return;
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'restarted' || result.status === 'started' || result.status === 'stopped') {
                    alert(`操作成功: ${result.status}`);
                    setTimeout(() => {
                        checkBotStatus();
                    }, 2000);
                } else {
                    alert(`操作失敗: ${result.msg || '未知錯誤'}`);
                }
            } catch (error) {
                console.error('機器人控制失敗:', error);
                alert('操作失敗，請檢查網路連接');
            }
        }

        async function checkBotStatus() {
            try {
                const response = await fetch('/api/bot');
                const data = await response.json();
                
                const statusElement = document.getElementById('bot-status');
                const statusText = document.getElementById('bot-status-text');
                
                if (data.online) {
                    statusElement.className = 'status-indicator status-online';
                    statusText.textContent = `在線 (PID: ${data.pid})`;
                } else {
                    statusElement.className = 'status-indicator status-offline';
                    statusText.textContent = '離線';
                }
            } catch (error) {
                console.error('檢查機器人狀態失敗:', error);
                const statusElement = document.getElementById('bot-status');
                const statusText = document.getElementById('bot-status-text');
                statusElement.className = 'status-indicator status-unknown';
                statusText.textContent = '狀態未知';
            }
        }

        // 歡迎卡片配置
        async function loadWelcomeCardConfig() {
            try {
                const response = await fetch('/api/welcome_config');
                const config = await response.json();
                
                // 填充表單
                document.getElementById('background-image').value = config.background_image || '';
                document.getElementById('font-file').value = config.font_file || '';
                document.getElementById('font-size').value = config.font_size || 60;
                document.getElementById('text-color').value = config.text_color || '#FFFFFF';
                document.getElementById('main-text-x').value = config.main_text_position?.x || 400;
                document.getElementById('main-text-y').value = config.main_text_position?.y || 200;
                document.getElementById('subtitle-x').value = config.subtitle_position?.x || 400;
                document.getElementById('subtitle-y').value = config.subtitle_position?.y || 300;
                
            } catch (error) {
                console.error('載入配置失敗:', error);
            }
        }

        async function loadAvailableFiles() {
            try {
                // 簡化版本，直接設定選項
                const bgSelect = document.getElementById('background-image');
                bgSelect.innerHTML = '<option value="">選擇背景圖片</option>';
                bgSelect.innerHTML += '<option value="welcome_card.png">welcome_card.png</option>';
                bgSelect.innerHTML += '<option value="歡迎卡片範本.png">歡迎卡片範本.png</option>';
                
                const fontSelect = document.getElementById('font-file');
                fontSelect.innerHTML = '<option value="">選擇字體文件</option>';
                fontSelect.innerHTML += '<option value="Arial_1.ttf">Arial_1.ttf</option>';
                fontSelect.innerHTML += '<option value="Arial_1_Bold.ttf">Arial_1_Bold.ttf</option>';
                
            } catch (error) {
                console.error('載入文件列表失敗:', error);
            }
        }

        async function saveConfig() {
            try {
                const config = {
                    background_image: document.getElementById('background-image').value,
                    font_file: document.getElementById('font-file').value,
                    font_size: parseInt(document.getElementById('font-size').value),
                    text_color: document.getElementById('text-color').value,
                    main_text_position: {
                        x: parseInt(document.getElementById('main-text-x').value),
                        y: parseInt(document.getElementById('main-text-y').value)
                    },
                    subtitle_position: {
                        x: parseInt(document.getElementById('subtitle-x').value),
                        y: parseInt(document.getElementById('subtitle-y').value)
                    }
                };
                
                const response = await fetch('/api/welcome_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.status === 'ok') {
                    alert('配置保存成功！');
                } else {
                    alert('配置保存失敗！');
                }
            } catch (error) {
                console.error('保存配置失敗:', error);
                alert('保存配置失敗，請檢查網路連接');
            }
        }

        async function generatePreview() {
            try {
                const previewContainer = document.getElementById('preview-container');
                previewContainer.innerHTML = `
                    <img src="/api/welcome_card?t=${Date.now()}" 
                         class="preview-image" 
                         alt="歡迎卡片預覽">
                `;
            } catch (error) {
                console.error('生成預覽失敗:', error);
                alert('生成預覽失敗，請檢查配置');
            }
        }

        // 頁面卸載時清理定時器
        window.addEventListener('beforeunload', function() {
            if (systemInfoInterval) clearInterval(systemInfoInterval);
            if (logsInterval) clearInterval(logsInterval);
        });
    </script>
</body>
</html> 